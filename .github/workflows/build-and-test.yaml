name: Audio Development

on:
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build plugins
    runs-on: ${{matrix.os}}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@master

      - name: Set up Xcode
        if: matrix.os == 'macos-latest'
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt install graphviz libasound2-dev libjack-jackd2-dev ladspa-sdk libcurl4-openssl-dev libfreetype6-dev libx11-dev libxcomposite-dev libxcursor-dev libxcursor-dev libxext-dev libxinerama-dev libxrandr-dev libxrender-dev libgtk-3-dev libwebkit2gtk-4.1-dev libglu1-mesa-dev mesa-common-dev libgtkmm-3.0-dev

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Register-PackageSource -ProviderName NuGet -Name nugetRepository -Location https://www.nuget.org/api/v2 -Force
          Install-Package Microsoft.Web.WebView2 -Scope CurrentUser -RequiredVersion 1.0.1901.177 -Source nugetRepository -Force

          # Download and install latest Inno Setup (6.5+) which supports PNG images
          Write-Host "Downloading latest Inno Setup from official source..."
          $url = "https://jrsoftware.org/download.php/is.exe?site=1"
          $output = "$env:TEMP\innosetup-installer.exe"
            
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
          Write-Host "✅ Inno Setup downloaded"
            
          Write-Host "Installing Inno Setup..."
          $installProcess = Start-Process -FilePath $output -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait -PassThru
          Write-Host "Inno Setup installer exit code: $($installProcess.ExitCode)"
          Write-Host "✅ Inno Setup installation completed"

      - name: Add msbuild to PATH
        if: matrix.os == 'windows-latest'
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64

      - name: Setup MSVC Environment and Export Variables
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          for /f "usebackq tokens=*" %%i in (`vswhere -latest -property installationPath`) do set VS_PATH=%%i
          call "%VS_PATH%\VC\Auxiliary\Build\vcvars64.bat"
          set >> %GITHUB_ENV%
      - name: Build
        run: |
          cmake --preset Release
          npm install
          npm run build --ws
          cmake --workflow --preset Release
      
      - name: Install plugins (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          cd build
          
          # Install all .exe files from the installers directory
          if (Test-Path "installers") {
            Get-ChildItem -Path "installers" -Filter "*.exe" | ForEach-Object {
              $installerPath = $_.FullName
              Write-Host "Installing: $($_.Name)"
              Write-Host "Full path: $installerPath"

              $process = Start-Process -FilePath $installerPath -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/CLOSEAPPLICATIONS", "/LOG" -Wait -PassThru

              # Check for installation logs
              Write-Host "Checking for installer logs..."

              # Check for Inno Setup log files (created by /LOG parameter)
              $logPattern = $env:TEMP + "\Setup Log*.txt"
              Get-ChildItem $env:TEMP -Filter "Setup Log*.txt" -ErrorAction SilentlyContinue | ForEach-Object {
                Write-Host "Found Inno Setup log: $($_.FullName)"
                Write-Host "Log contents (last 30 lines):"
                Get-Content $_.FullName -Tail 30 | ForEach-Object { Write-Host "  $_" }
              }
            }
          } else {
            Write-Host "No installers directory found"
            exit 0
          }
      - name: Install plugins (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          cd build

          # Install all .pkg files from the installers directory
          if [ -d "installers" ]; then
            find installers -name "*.pkg" -maxdepth 1 | while read pkg_file; do
              echo "Installing: $pkg_file"
              
              # Install and capture the package name from output
              installer_output=$(sudo installer -pkg "$pkg_file" -target / -verbose 2>&1 | tee /dev/stderr)
              app_name=$(echo "$installer_output" | grep "Package name is" | sed 's/installer: Package name is //' | xargs)
              
              # Quick check if app was installed
              if [ ! -z "$app_name" ] && [ -d "/Applications/$app_name.app" ]; then
                echo "✅ $app_name.app installed successfully"
              elif [ ! -z "$app_name" ]; then
                echo "❌ $app_name.app not found in /Applications"
                exit 1
              else
                echo "❌ Could not extract app name from installer output"
                exit 1
              fi
            done
          else
            echo "No installers directory found"
            exit 0
          fi

          # Kill AudioComponentRegistrar if running
          pgrep -x AudioComponentRegistrar >/dev/null && killall -9 AudioComponentRegistrar; echo "killed AudioComponentRegistrar" || echo "AudioComponentRegistrar Process not found"
        
      - name: Install plugins (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd build
          
          # Install all .tar.gz files from the installers directory
          if [ -d "installers" ]; then
            for tarball_file in installers/*.tar.gz; do
              if [ -f "$tarball_file" ]; then
                echo "Installing: $tarball_file"
                
                # Extract the tarball to system directories
                sudo tar -xzf "$tarball_file" -C / --strip-components=1
                
                # Extract plugin name from filename (remove path and version)
                plugin_name=$(basename "$tarball_file" | sed 's/-[0-9].*\.tar\.gz$//')
                echo "Looking for plugin: $plugin_name"
                
                # Verify VST3 plugin installation
                echo "Checking VST3 installation..."
                vst3_found=false
                if [ -d "/usr/lib/vst3" ]; then
                  echo "VST3 directory exists, listing contents:"
                  ls -la /usr/lib/vst3/
                  
                  for vst3_plugin in /usr/lib/vst3/*.vst3; do
                    if [ -d "$vst3_plugin" ]; then
                      vst3_name=$(basename "$vst3_plugin" .vst3)
                      echo "Found VST3 plugin: $vst3_name"
                      echo "✅ VST3 plugin installed successfully: $vst3_plugin"
                      vst3_found=true
                    fi
                  done
                else
                  echo "❌ /usr/lib/vst3 directory not found"
                fi
                
                # Verify standalone app installation
                echo "Checking standalone app installation..."
                standalone_found=false
                if [ -d "/usr/local/bin" ]; then
                  echo "Standalone apps directory exists, checking for executable:"
                  echo "All files in /usr/local/bin/:"
                  ls -la /usr/local/bin/
                  
                  # Check for any executable file (not just specific patterns)
                  # This handles cases where plugin names have spaces or different formatting
                  for app_path in /usr/local/bin/*; do
                    if [ -f "$app_path" ] && [ -x "$app_path" ]; then
                      app_name=$(basename "$app_path")
                      echo "Found executable: $app_name"
                      
                      # Check if this could be our plugin (flexible matching)
                      # Remove spaces and convert to lowercase for comparison
                      plugin_name_clean=$(echo "$plugin_name" | tr -d ' ' | tr '[:upper:]' '[:lower:]')
                      app_name_clean=$(echo "$app_name" | tr -d ' ' | tr '[:upper:]' '[:lower:]')
                      
                      if [[ "$app_name_clean" == *"$plugin_name_clean"* ]] || [[ "$plugin_name_clean" == *"$app_name_clean"* ]]; then
                        echo "✅ Standalone app installed successfully: $app_path"
                        standalone_found=true
                        break
                      fi
                    fi
                  done
                  
                  if [ "$standalone_found" = false ]; then
                    echo "No matching executable found for plugin: $plugin_name"
                    echo "Available executables:"
                    find /usr/local/bin -type f -executable 2>/dev/null || echo "None found"
                  fi
                else
                  echo "❌ /usr/local/bin directory not found"
                fi
                
                # Summary
                if [ "$vst3_found" = true ] && [ "$standalone_found" = true ]; then
                  echo "✅ All components installed successfully for $plugin_name"
                elif [ "$vst3_found" = true ]; then
                  echo "⚠️  VST3 installed but standalone app not found for $plugin_name"
                elif [ "$standalone_found" = true ]; then
                  echo "⚠️  Standalone app installed but VST3 not found for $plugin_name"
                else
                  echo "❌ Installation verification failed for $plugin_name"
                  exit 1
                fi
                
                echo "----------------------------------------"
              fi
            done
          else
            echo "No installers directory found"
            exit 0
          fi

      - name: Run Tests
        run: ctest --preset Release

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{matrix.os}}
          path: |
            build/**/*_artefacts/Release/AU/*
            build/**/*_artefacts/Release/Standalone/*
            build/**/*_artefacts/Release/VST3/*
            build/installers
            !build/**/_CPack_Packages
            !build/_deps/**
            !build/bin/**
            !build/CMakeFiles/**
  generate-docs:
    name: Verify Doxygen documentation generation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@master

      - name: Configure Doxygen
        run: cmake --preset Docs

      - name: Generate Documentation
        run: cmake --build --preset Docs
